# TLS / Let's Encrypt Setup Runbook

This document describes how to obtain and maintain valid TLS certificates for all
IISkills Cloud hostnames so that browsers (including Kaspersky-hardened ones) never
show an "untrustworthy website" warning.

---

## Hostnames covered

| PM2 process            | Hostname                         | Port |
|------------------------|----------------------------------|------|
| iiskills-main          | iiskills.cloud / www.iiskills.cloud | 3000 |
| iiskills-learn-ai      | learn-ai.iiskills.cloud          | 3024 |
| iiskills-learn-apt     | learn-apt.iiskills.cloud         | 3002 |
| iiskills-learn-chemistry | learn-chemistry.iiskills.cloud | 3005 |
| iiskills-learn-developer | learn-developer.iiskills.cloud | 3007 |
| iiskills-learn-geography | learn-geography.iiskills.cloud | 3011 |
| iiskills-learn-management | learn-management.iiskills.cloud | 3016 |
| iiskills-learn-math    | learn-math.iiskills.cloud        | 3017 |
| iiskills-learn-physics | learn-physics.iiskills.cloud     | 3020 |
| iiskills-learn-pr      | learn-pr.iiskills.cloud          | 3021 |

---

## Prerequisites

1. All DNS A-records point to the VPS IP (`72.60.203.189`).
2. Nginx is installed and the HTTP vhosts (port 80) for each hostname already exist
   (they are generated by `deploy-subdomains.sh`).
3. Port 80 is open in the firewall (needed for the ACME HTTP-01 challenge).

---

## Option A – Wildcard certificate via DNS-01 (recommended)

A single wildcard cert covers every current and future `*.iiskills.cloud` subdomain.
You need API access to your DNS provider (e.g. Cloudflare).

```bash
# Install certbot + Cloudflare DNS plugin
sudo apt-get update
sudo apt-get install -y certbot python3-certbot-dns-cloudflare

# Store Cloudflare API token
sudo mkdir -p /etc/letsencrypt
sudo tee /etc/letsencrypt/cloudflare.ini > /dev/null <<'EOF'
dns_cloudflare_api_token = <YOUR_CLOUDFLARE_API_TOKEN>
EOF
sudo chmod 600 /etc/letsencrypt/cloudflare.ini

# Obtain wildcard + apex cert (covers iiskills.cloud AND *.iiskills.cloud)
sudo certbot certonly \
  --dns-cloudflare \
  --dns-cloudflare-credentials /etc/letsencrypt/cloudflare.ini \
  -d iiskills.cloud \
  -d "*.iiskills.cloud" \
  --non-interactive \
  --agree-tos \
  --email admin@iiskills.cloud
```

The certificate will be stored at:
- `/etc/letsencrypt/live/iiskills.cloud/fullchain.pem`
- `/etc/letsencrypt/live/iiskills.cloud/privkey.pem`

Update each Nginx vhost to reference this single cert path instead of per-subdomain
paths.

---

## Option B – Per-host certificates via HTTP-01

Use this when DNS-01 is not available. Run one `certbot --nginx` command per hostname:

```bash
sudo apt-get update
sudo apt-get install -y certbot python3-certbot-nginx

# Main domain
sudo certbot --nginx \
  -d iiskills.cloud -d www.iiskills.cloud \
  --non-interactive --agree-tos \
  --email admin@iiskills.cloud --redirect

# Each subdomain (repeat for all subdomains listed above)
for sub in learn-ai learn-apt learn-chemistry learn-developer \
           learn-geography learn-management learn-math learn-physics learn-pr; do
  sudo certbot --nginx \
    -d "${sub}.iiskills.cloud" \
    --non-interactive --agree-tos \
    --email admin@iiskills.cloud --redirect
done
```

---

## Automatic renewal

Certbot installs a systemd timer that runs `certbot renew` twice daily.

```bash
# Verify timer is active
sudo systemctl status certbot.timer

# If not active, enable it
sudo systemctl enable --now certbot.timer

# Test renewal (dry run)
sudo certbot renew --dry-run
```

To reload Nginx after each renewal, add a deploy hook:

```bash
sudo tee /etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh > /dev/null <<'EOF'
#!/bin/bash
systemctl reload nginx
EOF
sudo chmod +x /etc/letsencrypt/renewal-hooks/deploy/reload-nginx.sh
```

---

## Validation

After certificates are issued, verify each hostname:

```bash
for host in iiskills.cloud www.iiskills.cloud \
            learn-ai.iiskills.cloud learn-apt.iiskills.cloud \
            learn-chemistry.iiskills.cloud learn-developer.iiskills.cloud \
            learn-geography.iiskills.cloud learn-management.iiskills.cloud \
            learn-math.iiskills.cloud learn-physics.iiskills.cloud \
            learn-pr.iiskills.cloud; do
  echo "=== $host ==="
  echo | openssl s_client -connect "${host}:443" -servername "$host" 2>/dev/null \
    | openssl x509 -noout -subject -issuer -dates -ext subjectAltName
  echo
done
```

Successful output shows:
- `issuer= /C=US/O=Let's Encrypt/CN=...`
- `notAfter` date at least 60 days in the future
- `subjectAltName` containing the queried hostname

---

## Certificate locations

| Type | Path |
|------|------|
| Wildcard cert (Option A) | `/etc/letsencrypt/live/iiskills.cloud/` |
| Per-host cert (Option B) | `/etc/letsencrypt/live/<hostname>/` |
| Renewal config | `/etc/letsencrypt/renewal/` |
| Deploy hooks | `/etc/letsencrypt/renewal-hooks/deploy/` |
| Certbot logs | `/var/log/letsencrypt/` |

---

## Troubleshooting

| Symptom | Action |
|---------|--------|
| Browser shows "invalid certificate" | Run `sudo certbot certificates` and check expiry |
| `certbot renew` fails | Ensure port 80 is open; check `/var/log/letsencrypt/letsencrypt.log` |
| Nginx 502 after cert issue | `pm2 status`; restart the affected app; `sudo nginx -t && sudo systemctl reload nginx` |
| DNS not propagated | Wait up to 48 h; verify with `dig A <subdomain>.iiskills.cloud` |
